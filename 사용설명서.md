# 영상 분석 프로그램 사용설명서

## 📌 프로그램 개요

이 프로그램은 교통 영상에서 **정지 차량**과 **사람**을 자동으로 검출하여 분석하는 도구입니다.

### 주요 기능
- ✅ 실시간 차량 추적 및 정지차 판단
- ✅ 사람 검출 및 표시
- ✅ 분석 결과를 영상으로 저장
- ✅ Python 설치 불필요 (단독 실행 파일)

---

## 🚀 빠른 시작

### 1단계: 프로그램 실행
- `영상분석프로그램.exe` 파일을 더블클릭하여 실행합니다.
- Python이나 다른 프로그램 설치가 필요 없습니다.

### 2단계: 영상 선택
1. **[영상 선택]** 버튼을 클릭합니다.
2. 분석하려는 영상 파일을 선택합니다.
   - 지원 형식: MP4, AVI, MOV, MKV
3. **[폴더 선택]** 버튼을 클릭하여, 특정 폴더 내의 모든 지원 영상 파일들을 한 번에 분석 목록에 추가할 수도 있습니다.

### 3단계: 분석 시작
1. **[분석 시작]** 버튼을 클릭합니다.
2. 진행 상태가 화면에 표시됩니다.
3. 분석 완료 시 자동으로 알림이 표시됩니다.

### 4단계: 결과 확인
- 분석된 영상은 **`result`** 폴더에 자동 저장됩니다.
- 파일명: `원본파일명_analyzed.mp4`

---

## 🎨 결과 화면 설명

분석된 영상에서는 다음과 같이 객체가 표시됩니다:

| 색상 | 의미 | 설명 |
|------|------|------|
| 🟢 **초록색** | 움직이는 차량 | 정상적으로 주행 중인 차량 |
| 🔴 **빨간색** | 정지 차량 (STOP) | 일정 시간 이상 정지한 차량 |
| 🔵 **파란색** | 사람 (PERSON) | 검출된 사람 |
| 🟣 **보라색** | 역주행 차량 (WRONG WAY) | 설정된 진행 방향과 반대로 주행하는 차량 |

각 객체에는 **ID 번호**가 표시되어 추적됩니다.

---

## ⚙️ 고급 설정 (선택사항)

기본 설정으로도 충분하지만, 필요시 다음 항목을 조정할 수 있습니다:

---

### 🚗 정지 차량 감지 설정

#### 정지 판단 프레임
- **기본값**: 150 프레임 (30fps 기준 약 5초)
- **설정 범위**: 1 ~ 300 프레임
- **의미**: 차량이 이 프레임 수만큼 계속 정지해 있어야 정지차로 판단합니다.
- **적용 위치**: video_analyzer.py:302, 312
- **조정 팁**:
  - **값을 크게 (예: 180)**: 더 오래 멈춰야 정지차로 판단 → 신호 대기 등 짧은 정지는 무시
  - **값을 작게 (예: 60)**: 빨리 정지차로 판단 → 민감하게 반응, 오검출 증가 가능
- **사용 예시**:
  - 고속도로: 120~150 프레임 권장 (빠른 흐름에서 실제 정지차만 검출)
  - 교차로: 150~180 프레임 권장 (신호 대기와 불법 정차 구분)

#### 최소 박스 크기
- **기본값**: 50 픽셀
- **설정 범위**: 1 ~ 200 픽셀
- **의미**: 바운딩 박스의 평균 크기(가로+세로 평균)가 이 값보다 작은 차량은 정지 판단에서 제외됩니다.
- **적용 위치**: video_analyzer.py:303
- **조정 팁**:
  - **값을 크게 (예: 100)**: 화면에서 멀리 있는 작은 차량 무시 → 가까운 차량만 검출
  - **값을 작게 (예: 30)**: 멀리 있는 작은 차량도 검출 → 전체 영역 모니터링
- **사용 예시**:
  - 근거리 주차장: 30~50 픽셀 (작은 차량도 감지)
  - 고속도로 원거리: 80~100 픽셀 (가까운 차량만 감지)

#### 정지 임계값 (최소)
- **기본값**: 12 픽셀
- **설정 범위**: 5 ~ 50 픽셀
- **의미**: 정지 판단 프레임 동안 차량이 이 거리 이내로만 움직이면 정지로 판단합니다. "정지 임계값 (비율)"과 함께 사용되어 둘 중 큰 값이 적용됩니다.
- **적용 위치**: video_analyzer.py:307
- **조정 팁**:
  - **값을 크게 (예: 25)**: 약간 움직여도 정지로 판단 → 느리게 움직이는 차량도 정지차로 간주
  - **값을 작게 (예: 8)**: 거의 완전히 멈춰야 정지로 판단 → 엄격한 정지 기준
- **사용 예시**:
  - 영상 흔들림이 큰 경우: 15~20 픽셀 (카메라 떨림 보정)
  - 고정 카메라: 8~12 픽셀 (정확한 정지 판단)

#### 정지 임계값 (비율)
- **기본값**: 0.06
- **설정 범위**: 0.01 ~ 0.2
- **의미**: 차량 박스 크기에 비례한 정지 임계값입니다. `박스 크기 × 이 비율`과 "정지 임계값 (최소)" 중 큰 값이 실제 정지 임계값으로 사용됩니다.
- **적용 위치**: video_analyzer.py:308
- **작동 방식**:
  - 큰 차량(박스 크기 200)일 때: 200 × 0.06 = 12 픽셀
  - 작은 차량(박스 크기 100)일 때: 100 × 0.06 = 6 픽셀 → 하지만 "정지 임계값 (최소)" 12가 적용됨
- **조정 팁**:
  - **값을 크게 (예: 0.1)**: 큰 차량에 대해 더 관대한 정지 판단
  - **값을 작게 (예: 0.03)**: 차량 크기와 무관하게 엄격한 정지 판단
- **사용 예시**:
  - 버스/트럭이 많은 경우: 0.08~0.1 (큰 차량의 미세한 흔들림 허용)
  - 승용차 위주 도로: 0.04~0.06 (정확한 정지 판단)

---

### 🤖 객체 검출 설정

#### 신뢰도 임계값
- **기본값**: 0.5
- **설정 범위**: 0.1 ~ 0.95
- **의미**: AI 모델이 검출한 객체 중 이 값 이상의 신뢰도(확률)를 가진 객체만 화면에 표시합니다.
- **적용 위치**: video_analyzer.py:245
- **조정 팁**:
  - **값을 크게 (예: 0.7)**: 확실한 객체만 표시 → 오검출 감소, 일부 객체 놓칠 수 있음
  - **값을 작게 (예: 0.3)**: 더 많은 객체 검출 → 오검출 증가, 놓치는 객체 감소
- **사용 예시**:
  - 야간/악천후: 0.3~0.4 (낮은 화질에서도 검출)
  - 주간/선명한 영상: 0.5~0.6 (정확한 검출 우선)

#### NMS IoU 임계값
- **기본값**: 0.5
- **설정 범위**: 0.1 ~ 0.9
- **의미**: 겹쳐진 박스들 중 중복을 제거할 때 사용하는 임계값입니다. IoU(Intersection over Union)가 이 값보다 크면 신뢰도가 낮은 박스를 제거합니다.
- **적용 위치**: video_analyzer.py:254 (nms_by_confidence 함수)
- **조정 팁**:
  - **값을 크게 (예: 0.7)**: 많이 겹쳐야 중복으로 간주 → 박스가 많이 표시될 수 있음
  - **값을 작게 (예: 0.3)**: 조금만 겹쳐도 중복으로 간주 → 깔끔한 표시, 일부 객체 누락 가능
- **사용 예시**:
  - 차량이 밀집된 경우: 0.4~0.5 (중복 박스 적극 제거)
  - 차량이 분산된 경우: 0.5~0.6 (안전하게 중복 제거)

---

### 🚨 역주행 감지 설정

#### [역주행 감지 사용] 체크박스
- **기본값**: 비활성화
- **의미**: 역주행 감지 기능을 활성화/비활성화합니다. 체크하면 아래 설정들이 활성화됩니다.
- **적용 위치**: video_analyzer.py:264
- **⚠️ 중요**: 이 기능을 활성화한 경우 **반드시 [진행 방향 설정]을 완료해야 합니다**. 방향을 설정하지 않고 분석을 시작하면 오류 메시지가 표시되며 분석이 시작되지 않습니다.

#### [진행 방향 설정] 버튼
- **사용 방법**:
  1. 버튼 클릭 시 영상의 첫 프레임이 나타납니다.
  2. 마우스로 **두 번 클릭**하여 올바른 진행 방향을 나타내는 화살표를 그립니다.
     - 첫 번째 클릭: 화살표 시작점
     - 두 번째 클릭: 화살표 끝점 (방향 표시)
  3. 여러 개의 방향 벡터를 설정할 수 있습니다. (다중 차선 도로에 유용)
  4. **초기화** 버튼으로 모든 벡터를 지울 수 있습니다.
- **작동 원리**: 설정된 방향과 반대로 움직이는 차량(코사인 유사도 < -0.3, 약 107도 이상 차이)을 역주행으로 판단합니다.
- **적용 위치**: video_analyzer.py:334-390

#### 역주행 판단 프레임
- **기본값**: 10 프레임
- **설정 범위**: 5 ~ 60 프레임
- **의미**: 이 프레임 수만큼 연속적으로 역주행이 감지되어야 최종적으로 역주행 차량으로 표시됩니다.
- **적용 위치**: video_analyzer.py:400
- **작동 원리**: 역주행 감지는 차량의 처음 위치부터 현재까지의 전체 이동 방향으로 판단합니다. 기준 방향과 코사인 유사도가 -0.3 미만(약 107도 이상 차이)일 때 역주행으로 감지됩니다.
- **조정 팁**:
  - **값을 크게 (예: 20)**: 더 오랫동안 역주행해야 판단 → 오검출 감소, U턴 차량 등 필터링
  - **값을 작게 (예: 5)**: 더 빠르게 역주행 판단 → 민감도 증가, 오검출 가능
- **사용 예시**:
  - 일방통행로: 5~10 프레임 (빠른 감지)
  - 복잡한 교차로: 15~20 프레임 (정확한 판단 우선)

---

### 💡 설정 조합 추천

#### 일반 도로 모니터링 (기본)
```
정지 판단 프레임: 150
최소 박스 크기: 50
정지 임계값 (최소): 12
정지 임계값 (비율): 0.06
신뢰도 임계값: 0.5
NMS IoU 임계값: 0.5
```

#### 고속도로 (빠른 흐름)
```
정지 판단 프레임: 120-150
최소 박스 크기: 80
정지 임계값 (최소): 15
정지 임계값 (비율): 0.08
신뢰도 임계값: 0.5
NMS IoU 임계값: 0.5
```

#### 주차장/저속 구간
```
정지 판단 프레임: 150-180
최소 박스 크기: 30
정지 임계값 (최소): 8
정지 임계값 (비율): 0.04
신뢰도 임계값: 0.5
NMS IoU 임계값: 0.5
```

#### 야간/악천후
```
정지 판단 프레임: 150
최소 박스 크기: 60
정지 임계값 (최소): 15
정지 임계값 (비율): 0.08
신뢰도 임계값: 0.3-0.4
NMS IoU 임계값: 0.4
```

---

## 📁 파일 구조

```
프로그램 폴더/
├── 영상분석프로그램.exe    (실행 파일)
└── result/                  (분석 결과 저장 폴더, 자동 생성)
    └── 영상파일명_analyzed.mp4
```

